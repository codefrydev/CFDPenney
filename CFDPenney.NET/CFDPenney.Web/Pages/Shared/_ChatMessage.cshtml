@model MessageViewModel
@using CFDPenney.Web.Models

@{
    var isOwn = Model.IsOwn;
}

<div class="chat-message-wrapper @(isOwn ? "own" : "")" data-message-id="@Model.Id">
    @if (!isOwn)
    {
        <div class="chat-message-avatar" style="background-color: @GetAvatarColor(Model.SenderId);">
            @GetInitials(Model.SenderName)
        </div>
    }
    
    <div class="chat-message-bubble">
        @if (!isOwn)
        {
            <div class="chat-message-sender">@Model.SenderName</div>
        }
        
        @if (Model.File != null)
        {
            <div class="chat-message-file">
                @if (Model.File.Type.StartsWith("image/"))
                {
                    <img src="@Model.File.Data" alt="@Model.File.Name" class="chat-message-image" onclick="window.open(this.src, '_blank')">
                }
                else
                {
                    <div class="chat-message-file-download" data-file-data="@Model.File.Data" data-file-name="@Model.File.Name" onclick="downloadFile(this.dataset.fileData, this.dataset.fileName)">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>@Model.File.Name</span>
                        <span class="chat-file-size">(@((Model.File.Size / 1024.0).ToString("F1")) KB)</span>
                    </div>
                }
            </div>
        }
        
        @if (!string.IsNullOrEmpty(Model.Content))
        {
            <div class="chat-message-text">@Model.Content</div>
        }
        
        @if (Model.EditedAt.HasValue)
        {
            <div class="chat-message-edited">Edited</div>
        }
        
        <div class="chat-message-footer">
            <div class="chat-message-time">@FormatTime(Model.Timestamp)</div>
            @if (isOwn && Model.ReadBy != null && Model.ReadBy.Count > 1)
            {
                <div class="chat-message-read">
                    <i data-lucide="check-check" class="w-4 h-4"></i>
                </div>
            }
        </div>
        
        @if (Model.Reactions != null && Model.Reactions.Any())
        {
            <div class="chat-message-reactions">
                @foreach (var reactionGroup in Model.Reactions.GroupBy(r => r.Emoji))
                {
                    <button class="chat-reaction-item" data-message-id="@Model.Id" data-emoji="@reactionGroup.Key" onclick="toggleReaction(this.dataset.messageId, this.dataset.emoji)">
                        <span>@reactionGroup.Key</span>
                        <span>@reactionGroup.Count()</span>
                    </button>
                }
            </div>
        }
        
        <button class="chat-reaction-btn" data-message-id="@Model.Id" onclick="showReactionPicker(this.dataset.messageId)">
            <i data-lucide="smile" class="w-3 h-3"></i>
        </button>
    </div>
</div>

@functions {
    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ');
        if (parts.Length >= 2)
            return (parts[0][0] + parts[1][0]).ToString().ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }
    
    private string GetAvatarColor(string id)
    {
        var colors = new[] { "#FF3B30", "#FF9500", "#FFCC00", "#4CD964", "#5AC8FA", "#007AFF", "#5856D6", "#AF52DE", "#FF2D55", "#FF6B6B" };
        var hash = 0;
        foreach (var c in id)
            hash = c + ((hash << 5) - hash);
        return colors[Math.Abs(hash) % colors.Length];
    }
    
    private string FormatTime(DateTime date)
    {
        return date.ToString("h:mm tt");
    }
}
