@model ChatModel

<div id="chat-messages-panel" class="chat-messages-panel">
    <div id="chat-messages-header" class="chat-messages-header">
        <div class="chat-messages-header-info">
            <div id="chat-session-info" class="chat-session-info">
                <h3 id="chat-session-title" class="chat-session-title">
                    @if (Model.SelectedConversation != null)
                    {
                        @Model.SelectedConversation.Name
                    }
                    else
                    {
                        <text>Select a conversation</text>
                    }
                </h3>
                <p id="chat-session-subtitle" class="chat-session-subtitle">
                    @if (Model.SelectedConversation != null)
                    {
                        <text>@Model.SelectedConversation.Participants.Count participant@(Model.SelectedConversation.Participants.Count != 1 ? "s" : "")</text>
                    }
                </p>
            </div>
        </div>
        <div class="chat-messages-header-actions">
            @if (Model.SelectedConversation != null)
            {
                <button id="btn-start-video-call" class="chat-header-button" title="Start Video Call" data-call-type="2">
                    <i data-lucide="video" class="w-5 h-5"></i>
                </button>
                <button id="btn-start-audio-call" class="chat-header-button" title="Start Audio Call" data-call-type="1">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                </button>
            }
            <button id="btn-toggle-details" class="chat-header-button" title="Show Details">
                <i data-lucide="info" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    
    <div id="chat-messages-container" class="chat-messages-container">
        <div id="chat-messages" class="chat-messages">
            @if (Model.SelectedConversation == null)
            {
                <div class="chat-empty-messages">
                    <i data-lucide="message-circle" class="w-16 h-16 text-gray-500 mb-4"></i>
                    <p class="text-gray-400 text-lg">Select a conversation to start messaging</p>
                </div>
            }
            else if (Model.Messages == null || !Model.Messages.Any())
            {
                <div class="chat-empty-messages">
                    <i data-lucide="message-circle" class="w-16 h-16 text-gray-500 mb-4"></i>
                    <p class="text-gray-400 text-lg">No messages yet. Start the conversation!</p>
                </div>
            }
            else
            {
                string? currentDate = null;
                @foreach (var message in Model.Messages.OrderBy(m => m.Timestamp))
                {
                    var msgDate = FormatDate(message.Timestamp);
                    if (msgDate != currentDate)
                    {
                        currentDate = msgDate;
                        <div class="chat-timestamp-divider">@msgDate</div>
                    }
                    
                    @await Html.PartialAsync("Shared/_ChatMessage", message)
                }
            }
        </div>
        
        <div id="chat-typing-indicator" class="chat-typing-indicator hidden">
            <div class="chat-typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span id="chat-typing-text" class="chat-typing-text"></span>
        </div>
    </div>
    
    <div id="chat-input-area" class="chat-input-area">
        @if (Model.SelectedConversation != null)
        {
            <div id="chat-file-preview" class="chat-file-preview hidden">
                <div class="chat-file-preview-content">
                    <div class="chat-file-preview-info">
                        <i data-lucide="file" class="w-4 h-4 text-gray-400"></i>
                        <span id="chat-file-name" class="chat-file-name"></span>
                        <span id="chat-file-size" class="chat-file-size"></span>
                    </div>
                    <button id="chat-file-remove" class="chat-file-remove">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <img id="chat-file-preview-img" class="chat-file-preview-img hidden" alt="Preview">
            </div>
            
            <div class="chat-input-container">
                <button id="chat-emoji-btn" class="chat-input-button" title="Add emoji">
                    <i data-lucide="smile" class="w-5 h-5"></i>
                </button>
                
                <button id="chat-file-btn" class="chat-input-button" title="Attach file">
                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                </button>
                <input type="file" id="chat-file-input" class="hidden" accept="image/*,application/pdf,.doc,.docx,.txt">
                
                <div class="chat-input-wrapper">
                    <textarea id="chat-input" rows="1" placeholder="Type a message..." class="chat-input"></textarea>
                </div>
                
                <button id="chat-send-btn" class="chat-send-button" title="Send message">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="emoji-picker" class="chat-emoji-picker hidden">
                <div class="chat-emoji-grid">
                    @{
                        var commonEmojis = new[] { "ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜Š", "ğŸ˜‡", "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", "ğŸ§", "ğŸ¤“", "ğŸ˜", "ğŸ¤©", "ğŸ¥³", "ğŸ˜", "ğŸ˜’", "ğŸ˜", "ğŸ˜”", "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£", "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ¥º", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "ğŸ¤", "ğŸ¤Ÿ", "ğŸ¤˜", "ğŸ‘", "ğŸ™Œ", "ğŸ‘", "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ–¤", "ğŸ¤", "ğŸ¤", "ğŸ’”", "ğŸ’¯", "ğŸ”¥", "â­", "âœ¨", "ğŸ’«", "ğŸŒŸ", "ğŸ’¥", "ğŸ’¢", "ğŸ’¤", "ğŸ’¨" };
                    }
                    @foreach (var emoji in commonEmojis)
                    {
                        <button class="chat-emoji-btn" data-emoji="@emoji">@emoji</button>
                    }
                </div>
            </div>
        }
    </div>
</div>

@functions {
    private string FormatDate(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);
        
        if (date.Date == today)
            return "Today";
        else if (date.Date == yesterday)
            return "Yesterday";
        else
            return date.ToString("MMM d") + (date.Year != today.Year ? $", {date.Year}" : "");
    }
}
