@model ChatModel
@using CFDPenney.Web.Models

<div id="chat-conversations-panel" class="chat-conversations-panel">
    <div class="chat-conversations-header">
        <h2 class="chat-conversations-title">Chats</h2>
        <div class="chat-conversations-header-actions">
            <button id="btn-new-group" class="chat-new-conversation-btn" title="New Group">
                <i data-lucide="users" class="w-5 h-5"></i>
            </button>
            <button id="btn-new-conversation" class="chat-new-conversation-btn" title="New Chat">
                <i data-lucide="plus" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    
    <div class="chat-conversations-search">
        <i data-lucide="search" class="w-4 h-4 chat-search-icon"></i>
        <input type="text" id="conversations-search-input" placeholder="Search conversations..." class="chat-search-input">
    </div>
    
    <div id="conversations-list" class="chat-conversations-list">
        @if (Model.Conversations == null || !Model.Conversations.Any())
        {
            <div class="chat-empty-state">
                <i data-lucide="message-square" class="w-12 h-12 text-gray-500 mb-2"></i>
                <p class="text-gray-400 text-sm">No conversations yet</p>
                <p class="text-gray-500 text-xs mt-1">Start a new chat or group to begin messaging</p>
            </div>
        }
        else
        {
            @foreach (var conversation in Model.Conversations.OrderByDescending(c => c.LastMessageAt ?? c.UpdatedAt))
            {
                var isActive = conversation.Id == Model.SelectedConversation?.Id;
                var otherParticipant = conversation.Type == ConversationType.Personal 
                    ? conversation.Participants.FirstOrDefault(p => p.UserId != Model.CurrentUserId)
                    : null;
                var otherUser = otherParticipant?.User;
                var otherPresence = otherUser?.Presence;
                
                <div class="chat-conversation-item @(isActive ? "active" : "")" 
                     data-conversation-id="@conversation.Id"
                     onclick="selectConversation('@conversation.Id')">
                    <div class="chat-conversation-avatar" style="background-color: @(otherUser?.GetAvatarColor() ?? "#007AFF");">
                        @if (conversation.Type == ConversationType.Personal && otherUser != null)
                        {
                            <text>@otherUser.GetInitials()</text>
                            @if (otherPresence?.Status == PresenceStatus.Online)
                            {
                                <div class="chat-presence-dot online"></div>
                            }
                        }
                        else
                        {
                            <text>@conversation.Name.Substring(0, Math.Min(2, conversation.Name.Length)).ToUpper()</text>
                        }
                    </div>
                    
                    <div class="chat-conversation-content">
                        <div class="chat-conversation-name">@conversation.Name</div>
                        <div class="chat-conversation-preview">
                            @if (conversation.LastMessage != null)
                            {
                                @if (conversation.LastMessage.File != null)
                                {
                                    <text>ðŸ“Ž @conversation.LastMessage.File.Name</text>
                                }
                                else
                                {
                                    <text>@(conversation.LastMessage.Content.Length > 50 ? conversation.LastMessage.Content.Substring(0, 50) + "..." : conversation.LastMessage.Content)</text>
                                }
                            }
                            else
                            {
                                <text>No messages yet</text>
                            }
                        </div>
                    </div>
                    
                    <div class="chat-conversation-meta">
                        @if (conversation.LastMessageAt.HasValue)
                        {
                            <div class="chat-conversation-time">@FormatTime(conversation.LastMessageAt.Value)</div>
                        }
                        @if (conversation.UnreadCount > 0 && !isActive)
                        {
                            <div class="chat-conversation-unread">@(conversation.UnreadCount > 99 ? "99+" : conversation.UnreadCount.ToString())</div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@functions {
    private string FormatTime(DateTime date)
    {
        var now = DateTime.Now;
        var diff = now - date;
        var minutes = (int)diff.TotalMinutes;
        var hours = (int)diff.TotalHours;
        var days = (int)diff.TotalDays;
        
        if (minutes < 1) return "Just now";
        if (minutes < 60) return $"{minutes}m";
        if (hours < 24) return $"{hours}h";
        if (days < 7) return $"{days}d";
        return date.ToString("MMM d");
    }
}
